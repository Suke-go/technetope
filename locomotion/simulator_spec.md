# toio 多体シミュレーター仕様書（抜粋版）
**版:** v0.1 / **対象:** ソフトウェア・シミュレーションのみ  
**目的:** 人の足軌跡を仮想的に与えたときに、toio 群が危険度ポテンシャル場に基づき「生物的」かつ安全な挙動を示すことを検証する。

---

## 0. サマリ
### 0.1 目的
- 危険度ポテンシャル場と確率的ゆらぎを用いた **学習なし自律移動** のアルゴリズムを検証する。
- toio 30 台規模を仮想マット上で制御し、**安全距離** と **滑らかな挙動** を維持できるか評価する。
- 足の短期予測や推定ノイズはシミュレーター側で生成されたサンプルを利用する。

### 0.2 非目的
- RealSense など実センサからの入力取得・キャリブレーション。
- BLE 通信、実機モータ制御、外部プロジェクタ連携。
- 複数マットの物理解体・設置手順。

---

## 1. シミュレーション環境
- **座標系:** toio プレイマット準拠の 2D 直交座標（原点と単位を mm 換算で固定）。
- **時間:** 固定ステップ（例: 60 Hz）。描画は任意だが、状態更新と同じ周期でロジックを実行する。
- **エンティティ:**
  - **FootTrack:** 人の足の軌道と速度を持つ。シミュレーションでは楕円軌道＋ノイズで生成する。
  - **ToioAgent:** 30 台までの移動体。実寸 70 mm × 32 mm を模した当たり判定（半径 35 mm を推奨）と heading を持つ。
- **フィールド:** 400 mm × 400 mm の正方マット内で動作させる。マージンや境界反射はフィールドサイズに基づき計算する。
- **安全距離:** 人との距離 $D_h = 100$ mm、ロボット間距離 $D_r = 60$ mm を下回らないこと。

---

## 2. グローバル場の定義
### 2.1 ポテンシャル関数
$$
U(x, t) = -\,\lambda_{\rho} \sum_k \int_{0}^{T} w(\tau)\, \mathcal{N}\!\bigl(x;\mu_k(\tau), \Sigma_k(\tau)\bigr)\, d\tau
$$
- 足由来のポテンシャルは危険度として **負値** を持つよう定義し、谷（値が小さい領域）を回避対象とする。
- $w(\tau) = \exp(-\beta \tau)$ とし、最新時刻ほど重み付けを大きくする。
- $\mu_k(\tau)$ は各 FootTrack の将来位置、$\Sigma_k(\tau)$ は進行方向に細長い楕円共分散。
- ポテンシャルの勾配が谷を形成する箇所が通過候補となる。

### 2.2 足シミュレーションに伴うポテンシャル変化
人間の足挙動を近似するため、各 FootTrack は以下のステートマシンで遷移する。
1. **Idle（滞在）:** 5–8 秒間、現在位置を中心に半径 30 mm 程度のゆらぎで足踏み。$\mu_k(\tau)$ はほぼ定位置で、ポテンシャル谷が固定される。
2. **Move-out（離脱）:** Idle 後に 1–2 秒の加速期間を経て、速度 120–200 mm/s で遠方（マット端またはランダム目標）へ直線移動。$\Sigma_k$ の主軸は進行方向に揃い、谷が移動する。
3. **Roam（移動継続）:** 3–6 秒間は目標周囲を周回または直線で往復。時折ランダムに向きを変え、ポテンシャル場の谷が滑らかに揺れる。
4. **Return（復帰）:** Roam 後は初期位置付近へ戻り、Idle に遷移。

各ステート遷移時、$\mu_k(\tau)$ は Ease-in/Ease-out 補間で連続性を保ち、$\Sigma_k$ も移動方向に応じてスケールと向きを更新する。これによりポテンシャル場が周期的に揺らぎ、toio 群が「遠くへ行く足」「その場に留まる足」の両ケースへ適応するようになる。

### 2.3 グローバルグリッドと勾配取得
- フィールド全体を等間隔グリッドに分割し、各セルで $U(x,t)$ を評価してキャッシュする。
- 勾配 $\nabla U$ は中心差分で算出し、`samplePotential(P)` / `sampleGradient(P)` の API でエージェントへ提供する。
- グローバル場は足シミュレーション更新後に再計算し、すべてのエージェントが同じデータを参照する。

### 2.4 正ポテンシャル領域（興味ポイント）
- 足由来の負ポテンシャルとは別に、システム全体に 10 個前後の **正ポテンシャルパッチ** を常時配置する。
- 仕様例:
  - 初期化時にマット内でランダム配置し、各パッチはガウシアン山（半径 30–60 mm、ピーク $+0.3 \lambda_{\rho}$ 以内）として加算。
  - 各フレームで 5–15 mm/s 程度の平滑なランダムウォークを適用し、境界で反射させてフィールド内をゆっくり漂わせる。
  - パッチごとに位相の異なるノイズシードを持たせ、動きが同期しないようにする。
  - 必要に応じて数十秒単位で新規パッチと入れ替え、空間的なバランスを維持する。
- これら正ポテンシャルは toio を緩く引き寄せる「興味領域」として機能し、負ポテンシャルの谷から出た後の分散や探索行動に多様性を与える。

---

## 3. 個別エージェント意思決定
### 3.1 希望速度とゆらぎ
- 各 ToioAgent は自身の位置で `sampleGradient` を呼び、希望速度 $v_{\text{pref}} = -\alpha \nabla U(x, t)$ を計算する。
- **ゆらぎ方式:** ガウスノイズを採用し、$v = v_{\text{pref}} + \mathcal{N}(0, \sigma_v^2 I)$ とする。

### 3.2 ローカルフィルタと速度更新
1. **境界フィルタ:** マット外へ出ないように速度を減衰・反射。
2. **安全フィルタ:** $D_r, D_h$ 未満になる速度にペナルティを加算し、最終速度を再計算。
3. **速度制限:** $\|v\| \leq v_{\max}$。
4. **状態更新:** heading の最大旋回速度を守りつつ、速度を積分して位置を進める。

---

## 4. マルチエージェント制御
- **状態:** $s_i = [x, y, \theta, v, \omega]$。姿勢は描画・ログ用。
- **更新:** 30–60 Hz で全エージェントを同期更新し、速度ベクトルを積分して位置を求める。
- **ノイズ:** 速度・足軌跡に小さなガウスノイズを加えて実機に近い揺らぎを再現する。
- **割当:** 目標点が複数ある場合は数秒ごとに最適化（例: ハンガリアン法）を適用しても良いが必須ではない。

---

## 5. 可視化
- マット枠とグリッド。
- FootTrack の現在位置と未来楕円。
- ポテンシャル場ヒートマップ。
- toio の速度ベクトル。

---

## 6. テスト・受入基準
- **安全距離:** シミュレーション 10 分相当のステップで $D_h, D_r$ 違反ゼロ。
- **滑らかさ:** 連続フレーム間の速度変化・角速度が設定上限を超えない（プロジェクトで上限値を定義）。
- **安定性:** ポテンシャル場とエージェント更新が発散せず、周期内で計算完了する。

---

## 7. 主要パラメータ初期値
- 予測窓 $T = 0.6\,\text{s}$、減衰 $\beta = 2.5$。
- $\lambda_{\rho} = 1.0$、$\alpha = 0.9$、$\sigma_v = 0.05$、温度 $T_e = 0.3$。
- 最大速度 $v_{\max} = 4.2$ (任意調整)。
- 安全距離: $D_h = 100\,\text{mm}$，$D_r = 60\,\text{mm}$。
- ロボット寸法: 70 mm × 32 mm（衝突計算は半径 35 mm を想定）。
- フィールドサイズ: 400 mm × 400 mm。

---

## 8. 参考
- 元仕様書の該当章: 0（目的）、5（行動決定）、6（マルチエージェント制御）、11（テスト）、付録 A。  
- 実機関連（センサ、BLE、キャリブレーション等）は本資料から意図的に除外している。
