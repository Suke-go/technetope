# toio×RealSense 多体協調アルゴリズム要件定義書（MECE）
**版:** v1.0（改訂1） / **言語:** 日本語 / **対象実装:** C++（macOS, Mac mini）  
**対応台数:** toio Core Cube 最大 30 台 / **センシング:** Intel RealSense D435（RGB-D）  
**主目的:** 人の足を回避・先読みしつつ「生物的」な挙動で toio 群を絶対座標上から制御する。

---

## 0. サマリ（目的・非目的）
### 0.1 目的（Scope）
- RealSense D435 から人の **足位置・短期予測** と **頭部 yaw（参考値）** を推定し，toio プレイマットの **絶対座標系** に統合する。
- **危険度ポテンシャル場** と軽微な確率的ゆらぎを組み合わせ，学習なしで **生物風の自律移動** を成立させる。
- 30 台規模を **BLE** 統括制御し，**安全性**（人・ロボット衝突回避）と **動きの滑らかさ** を両立させる。

### 0.2 非目的（Out of Scope）
- 現フェーズでは **深層学習 / 強化学習** による方策獲得を扱わない（将来拡張を参照）。
- 階段・段差などの **3D 地形ナビゲーション** は対象外（床が平面であることを前提）。
- toio 以外のロボットプラットフォームは本資料の適用範囲外。

---

## 1. システム前提・制約
- **OS / 言語:** macOS（Apple Silicon, Mac mini）＋C++17 以上。CMake によるビルドを想定。
- **ハードウェア構成:** RealSense D435（真上固定を推奨），公式 toio プレイマット（Position ID 印刷）。
- **実行周期:** 制御ループ 30–60 Hz（30 Hz 以上を推奨）。
- **拡張余地:** 将来的には **プロジェクタ投影** 連携（PnP による外部パラ推定）への拡張を想定。

---

## 2. 座標系と用語（MECE）
- **画像座標:** RealSense のカラー画像平面上でのピクセル座標。
- **カメラ座標:** カメラ原点を持つ右手座標系（必要時のみ使用）。
- **床（マット）座標:** toio Position ID 準拠の絶対 2D 座標。実寸換算時は mm/ID 比率を別途定義する。
- **世界座標:** 複数マットを貼り合わせた 2D 直交座標系。原点と回転はプロジェクトで定義する。

---

## 3. マッピング要件（画像→マット）
### 3.1 現行方式（2D ホモグラフィ）
- マットの四隅または格子に設置した **(Ch)ArUco マーカー** から対応点を検出し，`H = findHomography(..., RANSAC)` を推定する。
- 足の画像座標は毎フレーム `perspectiveTransform` により **床座標** へ変換する。
- **受入基準:** 既知点における再投影誤差を 5–8 ID 以内に維持する。

### 3.2 将来方式（3D 外部パラメータ / プロジェクタ対応）
- (Ch)ArUco ボードを用いて `solvePnP` によりカメラ姿勢 `(R, t)` を推定する。
- `projectPoints` を用い，画像↔床の正確な射影変換（プロジェクタ投影のキャリブレーションを含む）を実行する。

### 3.3 複数マット構成
- マットごとに `H_local` を算出し，Position ID のレンジを基準に平行移動・回転を適用して世界座標へ合成する。

---

## 4. センシング / 認識要件（最小限）
### 4.1 足・人体
- **足キーポイント:** MediaPipe Pose（C++）で **足首・踵・つま先** を画像座標上で推定する。
- **床面補正（任意）:** 深度画像から床平面を RANSAC 推定し，足ピクセルを床面へ直交投影（斜め設置やマットのたわみ対策）。
- **短時間予測:** 足ごとに **定速モデルのカルマンフィルタ**（状態 `[x, y, vx, vy]`）で 0.3–0.8 s 先を予測する。

### 4.2 頭部 yaw（参照情報）
- Face Mesh 等のランドマーク＋`solvePnP` で yaw を推定し，足進行方向の **危険度異方性** に反映する。ただし過大な重み付けは避ける。

---

## 5. 行動決定（学習なし / 生物風）
### 5.1 危険度ポテンシャル場
\[
U(x, t) = \lambda_{\rho} \sum_k \int_{0}^{T} w(\tau)\, \mathcal{N}\big(x;\mu_k(\tau), \Sigma_k(\tau)\big)\, d\tau
\]
- \(\mu_k(\tau)\): 各足の将来位置。 \(\Sigma_k(\tau)\): 進行方向に細長い楕円共分散（yaw と速度に応じて主軸を回転）。
- 足と足の間は自然に **サドル点（谷）** が生じ，条件が揃えば通過経路の候補とする。

### 5.2 意思決定ロジック
- 希望速度 \(v_{\text{pref}} = -\alpha \nabla U(x, t)\) を計算する。
- ゆらぎとして \(v \sim \mathcal{N}(v_{\text{pref}}, \sigma_v^2 I)\) または MaxEnt サンプリング（温度 \(T_e\)）を適用する。
- **安全フィルタ:** ORCA（RVO2）等で衝突しない最近傍速度へ射影する。

---

## 6. マルチエージェント制御（30 台）
- **状態定義:** toio \(s_i = [x, y, \theta, v, \omega]\)（Position ID と推定速度）。
- **更新周期:** 30–60 Hz で各機体に目標速度（または目標点）を配信し，モータ PWM に変換する。
- **割当（任意）:** 複数目標が存在する場合，数秒毎にハンガリアン法で最適再割当を実施する。

---

## 7. 通信（BLE）要件
- **通信ライブラリ:** SimpleBLE を採用（CoreBluetooth バックエンド）。
- **toio GATT:** Primary Service UUID `10B20100-5B3B-4571-9508-CF3EFCD7BBAE`  
  - Motor 制御特性 `10B20102-5B3B-4571-9508-CF3EFCD7BBAE`（Write / Write Without Response）。
  - Position / ID 取得は対応する Read / Notify 特性を購読して処理する。
- **スケーリング:** 30 台制御には複数ドングル利用またはタイムスライス配信で対応（1 台あたり 10–20 Hz が目安）。
- **フェイルセーフ:** 書き込み失敗が連続した場合は緊急停止コマンドを送出する。

---

## 8. 非機能要件（NFR）
- **レイテンシ:** センシングから指令送出までの総遅延を 200 ms 以下（目安）。
- **スループット:** 30 台同時制御時に 10 Hz 以上の指令更新を維持する。
- **安全距離:** 人・ロボット間距離 \(D_h\)，ロボット間距離 \(D_r\) をプロジェクト定義値以上に保つ。
- **堅牢性:** マーカー欠落や照度変動が生じても再推定により動作を継続できること。

---

## 9. キャリブレーション / 保守
### 9.1 初期キャリブレーション
1. RealSense の **depth→color アライン** を `rs2::align` で初期化し，ループ外で再利用する。  
2. (Ch)ArUco 検出 → `H` 推定 → 再投影誤差評価を行う。  
3. Position ID のレンジと実寸から **mm/ID** 比率を決定（必要に応じて）。

### 9.2 オンライン再補正（軽量）
- **マーカー再スナップ:** 数秒おきに隅マーカーを再検出し，RANSAC で `H` を微更新する。  
- **toio アンカー:** 任意 toio を既知 ID へ移動させ，画像座標との対応を `H` 更新に追加する。

---

## 10. ロギング / 可視化
- **時刻同期:** RealSense フレームタイムスタンプ，足座標（画像 / 床），toio 姿勢，指令速度を同一フレーム ID で記録する。
- **可視化:** 危険度場 \(U\) のヒートマップ，予測足軌跡，各 toio の速度ベクトルを重畳表示する。

---

## 11. テスト・受入基準
- **幾何精度:** 既知点での床座標誤差を 5–8 ID 以内に抑える。  
- **安全性:** 10 分連続試験で安全距離違反を 0 件とする（ORCA / CBF などで検証）。  
- **滑らかさ:** 曲率とジャークの上限（プロジェクト定義値）を満たす。  
- **スケーラビリティ:** 30 台制御時に 10 Hz 以上を安定して維持する。

---

## 12. セキュリティ / プライバシ
- BLE のペアリング鍵と MAC ランダム化を可能な範囲で適用する。
- カメラ画像の保存は既定で無効とし，必要時のみ明示的に保存する。

---

## 13. 将来拡張
- `solvePnP` による外部パラ推定を活用した 3D 射影および **プロジェクタ投影** への連携。
- MPC や RL を併用し，ORCA による安全制約下で行動分布を最適化する。

---

## 14. 成果物
- **ソースコード:** C++ ライブラリおよびデモ（CMake プロジェクト）。  
- **設定ファイル:** `calib.json`（カメラ内外部パラメータ，`H`，床平面，マット合成情報）。  
- **実行バイナリ:** `toio_master --config calib.json`。

---

## 付録 A: 主要パラメータ初期値
- 予測窓 \(T = 0.6\,\text{s}\)，重み \(w(\tau) = \exp(-\beta \tau)\)，\(\beta = 2.5\)。
- \(\lambda_{\rho} = 1.0\)，\(\alpha = 0.9\)，\(\sigma_v = 0.05\)，温度 \(T_e = 0.3\)。
- 安全距離: \(D_h = 100\,\text{mm}\)，\(D_r = 60\,\text{mm}\) 相当。

## 付録 B: 参照仕様
- **toio 技術仕様**（通信概要 / Position ID / GATT）。  
- **RealSense `rs2::align`**（depth→color 整列）。  
- **OpenCV ArUco / ChArUco / `findHomography` / `solvePnP`**。  
- **MediaPipe Pose Landmarker（C++）**。  
- **RVO2 / ORCA**（相互衝突回避）。  
- **SimpleBLE**（クロスプラットフォーム BLE）。

（URL は別資料を参照）
