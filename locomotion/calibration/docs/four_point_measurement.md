# 四点計測手順書

ChArUcoボードとtoio Position ID座標の対応点を4点計測する手順です。

## 概要

キャリブレーションには2つの変換ステップがあります：

1. **ホモグラフィ計算**（画像 → 床面）: ChArUcoボードから検出された**すべてのコーナーポイント**（通常12点以上）を使用してホモグラフィを計算します。これによりカメラの歪み補正と画像→床面の変換を行います。

2. **アフィン変換**（ボード座標 → toio Position ID）: ChArUcoボードの**4つの角**の対応点を使用して、ボード座標系からtoio Position ID座標系へのアフィン変換を計算します。

**重要**: 4つの角の対応点は、ホモグラフィ計算には使用されませんが、ボード座標からtoio Position ID座標への変換に必要です。

現在の設定では3点の対応点が定義されていますが、精度向上のため4点目の計測を推奨します。
- **最低要件**: 3点（アフィン変換に必要）
- **推奨**: 4点以上（精度向上と検証用）

## 計測手順

### 1. ChArUcoボードの4つの角を特定

ChArUcoボードの4つの角の座標（mm）は、ボードのサイズ設定から計算されます。
**生成方法（スクリプト）に関係なく、同じサイズ設定であれば常に同じ座標になります。**

#### 現在の設定（5x7グリッド、45mmマス）の場合

- **左上角**: `(0.0, 0.0)` - ボード座標系の原点（常に固定）
- **右上角**: `(180.0, 0.0)` - 幅 = (5-1) × 45mm = 180mm
- **左下角**: `(0.0, 270.0)` - 高さ = (7-1) × 45mm = 270mm
- **右下角**: `(180.0, 270.0)` - 対角点

#### 計算式（一般的な場合）

設定ファイル（`calibration_config.json`）の以下の値を使用：
- `charuco_squares_x`: 横方向のマス数（例: 5）
- `charuco_squares_y`: 縦方向のマス数（例: 7）
- `charuco_square_length_mm`: マス一辺の長さ [mm]（例: 45.0）

角の座標は以下の式で計算されます：

```
左上角: (0.0, 0.0)  # 常に原点
右上角: ((squares_x - 1) × square_length_mm, 0.0)
左下角: (0.0, (squares_y - 1) × square_length_mm)
右下角: ((squares_x - 1) × square_length_mm, (squares_y - 1) × square_length_mm)
```

**例（現在の設定: 5x7、45mm）:**
- 右上角: (4 × 45, 0) = (180, 0)
- 左下角: (0, 6 × 45) = (0, 270)
- 右下角: (4 × 45, 6 × 45) = (180, 270)

**注意**: ボードのサイズ設定が異なる場合（例: 6x8グリッド、またはsquare_length_mmが異なる場合）は、角の座標も変わります。必ず設定ファイルの値を確認してください。

### 2. toio Position ID座標の計測方法

**目的**: ChArUcoボードの4つの角が、toioプレイマット上のどのPosition ID座標に対応するかを計測します。
この対応点は、ボード座標系からtoio Position ID座標系へのアフィン変換を計算するために使用されます。

#### 方法A: toioキューブを使用（推奨）

1. ChArUcoボードをプレイマット上に配置（固定）
2. toioキューブをChArUcoボードの各角の位置に配置
3. toio SDKまたはアプリでPosition IDを読み取る
4. 各角のPosition ID座標を記録

**注意**: ボードの角の位置は、ボード座標系で `(0,0)`, `(180,0)`, `(0,270)`, `(180,270)` です。
これらの点がプレイマット上のどのPosition ID座標に対応するかを計測します。

#### 方法B: プレイマットの格子から推定

1. プレイマットのPDFまたは実測値から、ボードの各角がどの格子位置に相当するかを確認
2. 格子のPosition ID座標を記録

#### 方法C: 実測値から計算

1. ボードの各角からプレイマットの端（Start点）までの距離をmmで測定
2. 以下の式でPosition ID座標を計算：
   ```
   position_id.x = start_x + (距離_x_mm × id_per_mm.x)
   position_id.y = start_y + (距離_y_mm × id_per_mm.y)
   ```
   
   例（A3 Simple Playmat #01の場合）:
   ```
   position_id.x = 34.0 + (距離_x_mm × 0.7261904762)
   position_id.y = 35.0 + (距離_y_mm × 0.7239057239)
   ```

### 3. JSONファイルの更新

`locomotion/calibration/config/toio_playmat.json` の `correspondences` 配列に4点目を追加します。

#### 現在の3点（例）

```json
{
  "board_to_position_id": {
    "correspondences": [
      {
        "board_point_mm": { "x": 0.0, "y": 0.0 },
        "position_id": { "x": 121.1428571429, "y": 44.7727272727 }
      },
      {
        "board_point_mm": { "x": 180.0, "y": 0.0 },
        "position_id": { "x": 251.8571428571, "y": 44.7727272727 }
      },
      {
        "board_point_mm": { "x": 0.0, "y": 270.0 },
        "position_id": { "x": 121.1428571429, "y": 240.2272727273 }
      }
    ]
  }
}
```

#### 4点目を追加した例

```json
{
  "board_to_position_id": {
    "correspondences": [
      {
        "board_point_mm": { "x": 0.0, "y": 0.0 },
        "position_id": { "x": 121.1428571429, "y": 44.7727272727 }
      },
      {
        "board_point_mm": { "x": 180.0, "y": 0.0 },
        "position_id": { "x": 251.8571428571, "y": 44.7727272727 }
      },
      {
        "board_point_mm": { "x": 0.0, "y": 270.0 },
        "position_id": { "x": 121.1428571429, "y": 240.2272727273 }
      },
      {
        "board_point_mm": { "x": 180.0, "y": 270.0 },
        "position_id": { "x": 251.8571428571, "y": 240.2272727273 }
      }
    ]
  }
}
```

### 4. 計測の精度確認

キャリブレーション実行後、以下の値を確認します：

#### ホモグラフィの再投影誤差

- **再投影誤差（ピクセル）**: `reprojection_error_px`
  - **目標**: ≤ 3.0 pixels
  - **許容**: ≤ 8.0 pixels
- **再投影誤差（床面mm）**: `reprojection_error_floor_mm`
  - カメラの高さに依存しますが、一般的に ≤ 5mm が目標

#### アフィン変換の誤差

- **変換誤差（ID units）**: `transform_error_id`
  - **目標**: ≤ 2.0 ID units（≈ 1.5mm）
  - **許容**: ≤ 5.0 ID units（≈ 3.5mm）

この誤差は、4つの角の対応点を使って計算されたアフィン変換の精度を示します。

エラーが大きい場合は：
1. **4つの角の計測値の再確認**: Position ID座標が正しく計測されているか
2. **ボードの貼付位置の確認**: 歪み、傾きがないか
3. **プレイマットの実寸とID換算係数の確認**: `id_per_mm` の値が実測値と一致しているか
4. **ホモグラフィの精度確認**: 再投影誤差が大きい場合は、カメラの歪み補正やボードの検出精度を確認

## 実測例

### ボード座標系（5x7グリッド、45mmマスの場合）

```
(0, 0) ──────────────── (180, 0)
  │                         │
  │      ChArUco Board      │
  │       (5x7 grid)        │
  │    square_length: 45mm  │
  │                         │
(0, 270) ──────────────── (180, 270)
```

**座標の計算:**
- 幅: (5-1) × 45mm = 180mm
- 高さ: (7-1) × 45mm = 270mm

**重要**: ボードのサイズ設定が異なる場合は、上記の計算式を使用して角の座標を再計算してください。

### toio Position ID座標（例：中央配置の場合）

```
(121.14, 44.77) ──────────────── (251.86, 44.77)
      │                                 │
      │      ChArUco Board              │
      │      (centered on mat)          │
      │                                 │
(121.14, 240.23) ──────────────── (251.86, 240.23)
```

## 注意事項

1. **計測精度**: 各点の計測は ±2mm 以内の精度を目指してください
2. **ボードの配置**: ボードはプレイマットに対して平行に配置してください（傾きがないこと）
3. **複数回計測**: 可能であれば複数回計測して平均を取ることを推奨します
4. **検証**: 4点目を追加した後、既存の3点での変換誤差が増加していないか確認してください

## よくある質問

### Q: ホモグラフィ計算には4つの角だけを使うのではないか？

**A**: いいえ、ホモグラフィ計算にはChArUcoボードから検出された**すべてのコーナーポイント**（通常12点以上）を使用します。これにより、より高い精度で画像→床面の変換が可能になります。

4つの角の対応点は、**ボード座標系からtoio Position ID座標系へのアフィン変換**を計算するために使用されます。

### Q: なぜ4つの角の対応点が必要なのか？

**A**: ChArUcoボードの座標系（mm単位）とtoio Position ID座標系（ID units単位）は異なる座標系です。ボードをプレイマット上のどこに配置したかを知るため、4つの角の対応点を使ってアフィン変換を計算します。

### Q: プレイマットの4つの角にマーカーを置く必要はないのか？

**A**: いいえ、プレイマットの4つの角にマーカーを置く必要はありません。ChArUcoボード1つで十分です。ボードから検出されたコーナーを使ってホモグラフィを計算し、ボードの4つの角の対応点を使ってtoio座標への変換を行います。

### Q: 端っこの計算はpoint cloudとかで実行するってこと？

**A**: いいえ、point cloudでは実行しません。4つの角のtoio Position ID座標は**手動で計測**します（toioキューブを使用）。point cloudは床面の推定に使用されますが、4つの角の計測には使用されません。

詳細は `docs/CORNER_MEASUREMENT_EXPLANATION.md` を参照してください。

### Q: 中心座標をそれで設定するってこと？

**A**: いいえ、中心座標は手動で設定する必要はありません。4つの角の対応点からアフィン変換を計算し、その変換を使って中心座標やその他の任意の点のtoio Position ID座標を**自動的に計算**します。

詳細は `docs/CORNER_MEASUREMENT_EXPLANATION.md` を参照してください。

## トラブルシューティング

### 変換誤差が大きい場合

1. **計測値の見直し**: 各点のPosition ID座標が正しいか確認
2. **ボードの歪み**: ボードが平面から歪んでいないか確認
3. **プレイマットの歪み**: プレイマット自体が歪んでいないか確認
4. **ID換算係数**: `id_per_mm` の値が実測値と一致しているか確認
5. **ホモグラフィの精度**: 再投影誤差が大きい場合は、ボードの検出精度やカメラの歪み補正を確認

### 4点目を追加すると誤差が増える場合

- 4点目の計測値に誤差がある可能性があります
- 3点での変換誤差が小さい場合は、3点のままでも問題ありません
- 4点目は検証用として使用し、より正確な計測ができれば精度が向上します

## 参考

- `locomotion/calibration/config/toio_playmat.json` - 設定ファイル
- `locomotion/calibration/README.md` - キャリブレーション手順
- `locomotion/calibration/REQUIREMENTS_CALIBRATION_V2.md` - 要件仕様

